package com.example.openai0113.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.ChatOptions;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;

// Srping bean에는 ChatModel 타입 만 존재
@Service
public class OPENAITestService {
	/* OPENAITestService 의존 하는 객체는 ChatClient 임에도 어쩔수 없이 ChatModel 의존하게 된다.
	@Autowired private ChatModel chatModel;
	public String chat() {
		ChatClient chatClient = ChatClient.builder(chatModel).build();
	}
	*/
	
	// 직접 ChatClent를 의존하는 모양으로 변경 -> 생성자 주입을 사용하여야 한다
	private final ChatClient chatClient; // 빈이 존재하지 않아 AutoWired를 통해 주입 받을 수 없다. 

	public OPENAITestService(ChatModel chatModel) {
		this.chatClient = ChatClient.builder(chatModel).build();
	}
	
	// userMessage = "너 누구냐?";
	public String chat(String userMessage) { // 사용자가 전달하는 Message 매개값으로 받아 모델(OPENAI)에 전달
		String systemMessage = "조폭같이 대답해야해! 꼭!";
		return chatClient.prompt().user(userMessage).system(systemMessage).call().content();
	}
	
	// List<Message> 사용하면...
	// + ChatOptions 설정 추가
	public String chat2(String userMessage) {
		List<Message> messageList = new ArrayList<>();
		messageList.add(new SystemMessage("아주 친절하게 유치원 선생님 처럼 대답해"));
		messageList.add(new UserMessage(userMessage));
		// messageList.add(new AssistantMessage("이전 대화 목록을 메세지 형태로 추가 가능"));
		Prompt prompt = new Prompt(messageList);
		ChatOptions options = ChatOptions.builder()
								.model("gpt-4o-mini")
								.temperature(0.5) // 0.0~2.0 기본값1,  보통 0.7~1.0 높으면 높을 수록 창의적 대답
								.maxTokens(500) // 기본값이 무제한
								.frequencyPenalty(0.4) // 기본값 0.0, 높을수록 단어의 반복이 증가
								.presencePenalty(0.3) // 기본값 0.0, 새로운 주제 유도 안함
								
								
		return chatClient.prompt(prompt).options(options).call().content();
	}
}