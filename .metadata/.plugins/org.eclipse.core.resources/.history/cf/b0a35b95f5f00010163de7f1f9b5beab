package com.example.openai0113.service;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.model.ChatResponse;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.openai0113.dto.ChatMessage;
import com.example.openai0113.dto.ChatMessageRequest;
import com.example.openai0113.dto.ChatMessageResponse;
import com.example.openai0113.mapper.ChatMessageMapper;

@Service
public class ChatMessageService {
	private final ChatClient chatClient;
	private final ChatMessageMapper chatMessageMapper;
	// 생성자 주입
	public ChatMessageService(ChatClient.Builder chatClientbuild, ChatMessageMapper chatMessageMapper) {
		this.chatClient = chatClientbuild.build();
		this.chatMessageMapper = chatMessageMapper;
	}
	
	private final String REF_SYSTEM_MESSAGE = """
			당신은 "Awesome Tech"라는 회사의 E-커머스 고객 지원 챗봇입니다.
         항상 친절하고 명확하게 답변해야 합니다. 사용자가 상품에 대해서 물으면 아래 정보를 기반으로 답해주세요.
         
         - 상품명: 갤럭시 AI 북
         - 가격: 1,500,000원
         - 특징: 최신 AI 기능이 탑재된 고성능 노트북, 가볍고 배터리가 오래 갑니다
         - 재고: 현재 구매 가능
         
         - 상품명: AI 스마트 워치
         - 가격: 300,000
         - 특징: 건강 모니터닐과 스마트폰 연동 기능 제공, 방수 기능 포함.
         - 재고: 품절(5일 후 재입고 예정)
         
         내부에 없는 정보 일 경우, 정중하게 안내하면서도 일반적인 정보나 유사한 내용을 최대한 제공해 주세요
	""";
	
	@Transactional
	public List<ChatMessageResponse> getChatMessageList(ChatMessageRequest chatMessageRequest){
		// SystemMessage : REF_SYSTEM_MESSAGE
		// UserMessage : chatMessageRequest.getUserMessage()
		// AssistantMessage : chatMessageRequest.getUserMessage(String uid)
		
		// 1) DB에서 가져온 현재 사용자의 chat_message를 가져온다
		String userId = chatMessageRequest.getUserId();
		
		// 이전의 모든 대화목록 다 가져온다 -> 최근 날짜만 가지고 오는 구성이 필요하다.
		List<ChatMessage> previousMessages = chatMessageMapper.selectByUserId(REF_SYSTEM_MESSAGE);
		
		// 2) List<message> : Message <- UserMessage / SustemMessage / AssistantMessage
		// previousMessage를 UserMessage와 AssistantMessage로 구분해서 추가
		// history 이전 Message들의 List
		List<Message> history = previousMessages
						.stream()
						.map(c -> c.getIsUser().equals("Y")
								? new UserMessage(c.getContent())
								: new AssistantMessage(c.getContent()))
						.collect(Collectors.toList());
								
		// 3) 현재 Message List
		SystemMessage systemMessage = new SystemMessage(REF_SYSTEM_MESSAGE);
		UserMessage userMessage = new UserMessage(chatMessageRequest.getUserMessage()); 
		
		// 4) history + history + userMessage -> 하나의 List<Message>
		List<Message> currentMessageList = new ArrayList<Message>();
		currentMessageList.add(systemMessage);
		currentMessageList.addAll(history);
		currentMessageList.add(userMessage);		
		
		// 5) currentMessageList 프롬포트를 생성해서 질의
		// 							-> 현재 응답메세지와 현재 사용자 메세지도 DB에 저장
		Prompt prompt = new Prompt(currentMessageList);
		ChatResponse chatResponse = chatClient.prompt(prompt).call().chatResponse(); //
		
		// chatResonse 필터링이 필요하면 필터링 코드 or 추가문구... 구현
		
		// 필터링 or 추가가 없다면 chatClient.prompt(prompt).call().content() 동일
		String aiResponseMessage = chatResponse.getResult().getOutput().getText();
		
		// 6) 현재 응답메세지와 현재 사용자 메세지도 DB에 저장
		ChatMessage saveUserMessage = new ChatMessage();
		saveUserMessage.setUserId(chatMessageRequest.getUserId());
		saveUserMessage.setContent(aiResponseMessage);
		saveUserMessage.setIsUser("Y");
		
		ChatMessage saveAiResponseMessage = new ChatMessage();
		saveAiResponseMessage.setUserId(chatMessageRequest.getUserId());
		saveAiResponseMessage.setContent(aiResponseMessage);
		saveAiResponseMessage.setIsUser("N");
		
		// 트랜잭션 처리
		chatMessageMapper.insert(saveUserMessage);
		chatMessageMapper.insert(saveAiResponseMessage);
		
		// 7) 사용자에 응답할 내용(DTO)를 응답
		List<ChatMessageResponse> responseList = new ArrayList<>();
		responseList.add(new ChatMessageResponse("YOU", chatMessageRequest.getUserMessage()));
		responseList.add(new ChatMessageResponse("AI", aiResponseMessage));
		
		return responseList;
	}   
}
