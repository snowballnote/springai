package com.example.openai0113.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.model.ChatResponse;
import org.springframework.ai.chat.prompt.ChatOptions;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;

import com.example.openai0113.dto.SentimentResponse;
import com.example.openai0113.dto.SentimentResponse2;

@Service
public class Test2Service {
	private final ChatClient chatClient;
	public Test2Service(ChatClient.Builder builder) {
		this.chatClient = builder.build();
	}
	
	// test7()
	public String useAssistantMessage(String userMessage) { // 근처 맛집 위치좀 알려줘
		List<Message> msg = new ArrayList<>();
		// new AssistantMessage("");
		msg.add(new SystemMessage("넌 친절한 AI모델이야"));
		msg.add(new AssistantMessage("가산디지털단지역 1번 출구는 동쪽이야")); // AI가 이전에 응답했던 메세지로 간주하고 응답을 준비
		msg.add(new UserMessage(userMessage));
		
		Prompt prompt = new Prompt(msg);
		ChatOptions chatOptions = ChatOptions.builder().maxTokens(500).build();
		return chatClient.prompt(prompt)
				.options(chatOptions)
				.call()
				.content();
	}
	
	// test5()
	// 특별한 응답타입을 지정해서 반환 - SentimentResponse
	public SentimentResponse2 getSentimentResponse2(String userMessage) {
		
		String preTxt = "현재 나의 기분을 POSITIVE, NEUTRAL, NEGATIVE 중에 하나로 응답해. 나의 메세지는 ";
		
		List<Message> msg = new ArrayList<>();
		// new AssistantMessage("");
		msg.add(new SystemMessage("넌 친절한 AI모델이야"));
		msg.add(new UserMessage(preTxt+userMessage));
		
		Prompt prompt = new Prompt(msg);
		ChatOptions chatOptions = ChatOptions.builder().maxTokens(500).build();
		return chatClient.prompt(prompt)
				.options(chatOptions)
				.call()
				.entity(SentimentResponse2.class);
	}
	
	
	// test4()
	// 특별한 응답타입을 지정해서 반환 - SentimentResponse
	public SentimentResponse getSentimentResponse(String userMessage) {
		List<Message> msg = new ArrayList<>();
		msg.add(new SystemMessage("넌 친절한 AI모델이야"));
		msg.add(new UserMessage(userMessage));
		Prompt prompt = new Prompt(msg);
		ChatOptions chatOptions = ChatOptions.builder().maxTokens(500).build();
		return chatClient.prompt(prompt)
				.options(chatOptions)
				.call()
				.entity(SentimentResponse.class);
	}
	
	// AI모델에서 문자열을 반환
	
	// test3()
	// AI모델이 반환하는 타입 ChatResponse
	public ChatResponse getChatRespone(String userMessage) {
		List<Message> msg = new ArrayList<>();
		msg.add(new SystemMessage("넌 친절한 AI모델이야"));
		msg.add(new UserMessage(userMessage));
		Prompt prompt = new Prompt(msg);
		ChatOptions chatOptions = ChatOptions.builder().maxTokens(500).build();
		return chatClient.prompt(prompt)
						.options(chatOptions)
						.call()
						.chatResponse(); // content()는 이 결과에서 text(응답문자열)속성만 추출해 반환하는 값이다.
	}
}